<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yatırım Takip Sistemi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }

        .lucide-icon {
            width: 24px;
            height: 24px;
            stroke: currentColor;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
            fill: none;
        }

        .icon-sm {
            width: 16px;
            height: 16px;
        }

        .icon-lg {
            width: 32px;
            height: 32px;
        }

        .modal-backdrop {
            backdrop-filter: blur(8px);
        }

        .hide {
            display: none !important;
        }

        .table-responsive {
            overflow-x: auto;
        }

        @media (max-width: 768px) {
            .responsive-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div id="app"></div>

    <script>
        // Global State
        let state = {
        currentScreen: 'login', // <-- Bunu 'currentPage' yerine 'currentScreen' yap
        currentTab: 'dashboard',
        currentUser: null,
        searchQuery: '',
        selectedClient: null,
        transactionForm: {
            selectedAccount: '',
            transactionType: 'ALIS', // ALIS, SATIS
            selectedAsset: '',
            amount: '',
            unitPrice: ''
        },
        showSuccess: false,
        // Filtreleme state'ini de buraya ekleyelim ki hata almayasın
        filterState: {
            selectedAccount: 'all',
            selectedType: 'all',
            dateFrom: '',
            dateTo: ''
        },
        showNewAccountModal: false,
        newAccountForm: {
            selectedBroker: '',
            initialDeposit: '',
            commissionPlan: 'Standart Plan'
        }
    };
        // Mock Data -- chate attım bu arayı
//const user kısmı chat talimatıyla silindi
 
        let latestTransactions = [];

        let brokerData = {
            name: 'Mehmet Yıldırım',
            position: 'Kıdemli Yatırım Danışmanı',
            email: 'mehmet.yildirim@broker.com',
            totalCommission: 124500,
            monthlyCommission: 18750,
            accountCount: 24,
            activeClients: 21
        };

        let recentTransactions = [ ];//boş dizi yaptık

        let monthlyStats = [];//boş dizi yaptık


        let clients = [];//boş dizi yaptık

        let accounts = [];//boş dizi yaptık
        let investorInfo = null; // Risk ve Broker bilgilerini tutacak

        let assets = [
        ];

        const investorData = {
            name: 'Ayşe Kaya',
            email: 'ayse.kaya@email.com',
            phone: '+90 532 111 22 33',
            riskProfile: { name: 'Dengeli', description: 'Orta düzey risk toleransı ile dengeli portföy yapısı', maxStockRatio: 60 },
            broker: { name: 'Mehmet Yıldırım', phone: '+90 532 987 65 43', email: 'mehmet.yildirim@broker.com' }
        };

        const availableBrokers = [
            { id: 1, name: 'Mehmet Yıldırım', email: 'mehmet.yildirim@broker.com', phone: '+90 532 987 65 43' },
            { id: 2, name: 'Elif Demir', email: 'elif.demir@broker.com', phone: '+90 532 111 22 33' },
            { id: 3, name: 'Ahmet Kaya', email: 'ahmet.kaya@broker.com', phone: '+90 532 222 33 44' },
            { id: 4, name: 'Zeynep Aydın', email: 'zeynep.aydin@broker.com', phone: '+90 532 333 44 55' }
        ];

        let investorAccounts = [        ];//chatle değişirdim

        let transactions = [];//chatle değiştirdim

        let portfolioPositions = [];//boş dizi yaptık

        // Utility Functions
        function formatCurrency(amount) {
            return new Intl.NumberFormat('tr-TR').format(amount);
        }

        function getRiskColor(riskName) {
            const colors = {
                'Agresif': 'bg-red-100 text-red-800 border-red-200',
                'Dengeli': 'bg-yellow-100 text-yellow-800 border-yellow-200',
                'Muhafazakar': 'bg-green-100 text-green-800 border-green-200'
            };
            return colors[riskName] || 'bg-gray-100 text-gray-800 border-gray-200';
        }

        // SVG Icons
        const icons = {
            trendingUp: '<svg class="lucide-icon" viewBox="0 0 24 24"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline></svg>',
            trendingDown: '<svg class="lucide-icon" viewBox="0 0 24 24"><polyline points="23 18 13.5 8.5 8.5 13.5 1 6"></polyline><polyline points="17 18 23 18 23 12"></polyline></svg>',
            lock: '<svg class="lucide-icon" viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>',
            user: '<svg class="lucide-icon" viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>',
            chevronDown: '<svg class="lucide-icon" viewBox="0 0 24 24"><polyline points="6 9 12 15 18 9"></polyline></svg>',
            chevronRight: '<svg class="lucide-icon" viewBox="0 0 24 24"><polyline points="9 18 15 12 9 6"></polyline></svg>',
            briefcase: '<svg class="lucide-icon" viewBox="0 0 24 24"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path></svg>',
            barChart3: '<svg class="lucide-icon" viewBox="0 0 24 24"><path d="M3 3v18h18"></path><path d="M18 17V9"></path><path d="M13 17V5"></path><path d="M8 17v-3"></path></svg>',
            users: '<svg class="lucide-icon" viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>',
            plus: '<svg class="lucide-icon" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>',
            logOut: '<svg class="lucide-icon" viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>',
            dollarSign: '<svg class="lucide-icon" viewBox="0 0 24 24"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>',
            calendar: '<svg class="lucide-icon" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>',
            activity: '<svg class="lucide-icon" viewBox="0 0 24 24"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></svg>',
            arrowUpRight: '<svg class="lucide-icon" viewBox="0 0 24 24"><line x1="7" y1="17" x2="17" y2="7"></line><polyline points="7 7 17 7 17 17"></polyline></svg>',
            arrowDownRight: '<svg class="lucide-icon" viewBox="0 0 24 24"><line x1="7" y1="7" x2="17" y2="17"></line><polyline points="17 7 17 17 7 17"></polyline></svg>',
            download: '<svg class="lucide-icon" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>',
            search: '<svg class="lucide-icon" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>',
            phone: '<svg class="lucide-icon" viewBox="0 0 24 24"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg>',
            mail: '<svg class="lucide-icon" viewBox="0 0 24 24"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>',
            shield: '<svg class="lucide-icon" viewBox="0 0 24 24"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>',
            x: '<svg class="lucide-icon" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>',
            checkCircle: '<svg class="lucide-icon" viewBox="0 0 24 24"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>',
            alertCircle: '<svg class="lucide-icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>',
            wallet: '<svg class="lucide-icon" viewBox="0 0 24 24"><path d="M21 12V7H5a2 2 0 0 1 0-4h14v4"></path><path d="M3 5v14a2 2 0 0 0 2 2h16v-5"></path><path d="M18 12a2 2 0 0 0 0 4h4v-4Z"></path></svg>',
            receipt: '<svg class="lucide-icon" viewBox="0 0 24 24"><path d="M4 2v20l2-1 2 1 2-1 2 1 2-1 2 1 2-1 2 1V2l-2 1-2-1-2 1-2-1-2 1-2-1-2 1-2-1z"></path><path d="M16 8h-6a2 2 0 1 0 0 4h4a2 2 0 1 1 0 4H8"></path><path d="M12 17V7"></path></svg>',
            pieChart: '<svg class="lucide-icon" viewBox="0 0 24 24"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"></path><path d="M22 12A10 10 0 0 0 12 2v10z"></path></svg>',
            creditCard: '<svg class="lucide-icon" viewBox="0 0 24 24"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect><line x1="1" y1="10" x2="23" y2="10"></line></svg>',
            filter: '<svg class="lucide-icon" viewBox="0 0 24 24"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon></svg>',
            package: '<svg class="lucide-icon" viewBox="0 0 24 24"><line x1="16.5" y1="9.4" x2="7.5" y2="4.21"></line><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>',
            pauseCircle: '<svg class="lucide-icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><line x1="10" y1="15" x2="10" y2="9"></line><line x1="14" y1="15" x2="14" y2="9"></line></svg>',
            playCircle: '<svg class="lucide-icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><polygon points="10 8 16 12 10 16 10 8"></polygon></svg>'
        };

        // Render Functions
        function renderLoginScreen() {
            return `
                <div class="min-h-screen bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 flex items-center justify-center p-4">
                    <div class="max-w-md w-full">
                        <div class="text-center mb-8">
                            <div class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-blue-600 to-indigo-600 rounded-2xl mb-4 shadow-lg">
                                ${icons.trendingUp}
                            </div>
                            <h1 class="text-3xl font-bold text-gray-900 mb-2">Yatırım Takip Sistemi</h1>
                            <p class="text-gray-600">Hesabınıza giriş yapın</p>
                        </div>

                        <div class="bg-white rounded-2xl shadow-xl p-8 border border-gray-100">
                            <form id="loginForm" class="space-y-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Giriş Tipi</label>
                                    <div class="relative">
                                        <select id="userType" class="w-full px-4 py-3 pr-10 bg-gray-50 border border-gray-300 rounded-xl appearance-none focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all">
                                            <option value="investor">Yatırımcı</option>
                                            <option value="broker">Broker / Çalışan</option>
                                        </select>
                                        <div class="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none">${icons.chevronDown}</div>
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Kullanıcı Adı</label>
                                    <div class="relative">
                                        <div class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">${icons.user}</div>
                                        <input type="text" id="username" placeholder="kullanici.adi" 
                                            class="w-full pl-10 pr-4 py-3 bg-gray-50 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all" required />
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Şifre</label>
                                    <div class="relative">
                                        <div class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">${icons.lock}</div>
                                        <input type="password" id="password" placeholder="••••••••" 
                                            class="w-full pl-10 pr-4 py-3 bg-gray-50 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all" required />
                                    </div>
                                </div>

                                <button type="submit" class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 text-white py-3 rounded-xl font-medium hover:from-blue-700 hover:to-indigo-700 transition-all shadow-lg hover:shadow-xl">
                                    Giriş Yap
                                </button>
                            </form>

                            <div class="mt-6 pt-6 border-t border-gray-200">
                                <p class="text-xs text-gray-500 mb-3">Demo hesapları:</p>
                                <div class="space-y-2 text-xs">
                                    <div class="bg-blue-50 p-3 rounded-lg">
                                        <p class="text-blue-900"><span class="opacity-75">Yatırımcı:</span> ayse.kaya / investor123</p>
                                    </div>
                                    <div class="bg-indigo-50 p-3 rounded-lg">
                                        <p class="text-indigo-900"><span class="opacity-75">Broker:</span> mehmet.yildirim / broker123</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
//-----------------------
        function renderBrokerPerformanceTab() {
            // Veri Kontrolü
            let stats = monthlyStats;
            
            // DEBUG: Veriyi konsola yazdıralım
            console.log("Grafik için gelen ham veri:", stats);

            if (!stats || stats.length === 0) {
                console.log("Veri yok, boş grafik hazırlanıyor.");
                // Veri yoksa, içinde bulunduğumuz ayı boş gösterelim
                const today = new Date();
                const currentMonth = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
                stats = [{ month: currentMonth, commission: 0 }];
            }

            // Verileri Ayıkla
            const chartLabels = stats.map(s => s.month); 
            const chartData = stats.map(s => parseFloat(s.commission).toFixed(2)); // Sayıya çevir

            // HTML Şablonu
            setTimeout(() => {
                const chartEl = document.querySelector("#performanceChart");
                
                if (chartEl && typeof ApexCharts !== 'undefined') {
                    chartEl.innerHTML = ""; // Temizle

                    const options = {
                        series: [{
                            name: "Aylık Komisyon",
                            data: chartData
                        }],
                        chart: {
                            height: 350,
                            type: 'area', // 'bar' veya 'line' da deneyebilirsin
                            fontFamily: 'Inter, sans-serif',
                            toolbar: { show: false },
                            zoom: { enabled: false }
                        },
                        dataLabels: { enabled: false },
                        stroke: { curve: 'smooth', width: 2 },
                        xaxis: {
                            categories: chartLabels,
                            type: 'category', // Tarih formatı sorunu olmasın diye string category yapıyoruz
                            axisBorder: { show: false },
                            axisTicks: { show: false }
                        },
                        yaxis: {
                            labels: {
                                formatter: function (value) {
                                    return "₺" + new Intl.NumberFormat('tr-TR').format(value);
                                }
                            }
                        },
                        colors: ['#4F46E5'],
                        fill: {
                            type: 'gradient',
                            gradient: {
                                shadeIntensity: 1,
                                opacityFrom: 0.7,
                                opacityTo: 0.2,
                                stops: [0, 90, 100]
                            }
                        },
                        tooltip: {
                            y: {
                                formatter: function (val) {
                                    return "₺" + new Intl.NumberFormat('tr-TR').format(val)
                                }
                            }
                        },
                        noData: {
                            text: 'Görüntülenecek veri yok',
                            align: 'center',
                            verticalAlign: 'middle',
                            style: {
                                color: '#888',
                                fontSize: '16px'
                            }
                        }
                    };

                    const chart = new ApexCharts(chartEl, options);
                    chart.render();
                } else {
                    console.error("Grafik alanı (#performanceChart) bulunamadı veya ApexCharts yüklenmedi.");
                }
            }, 300); // Süreyi biraz artırdım (DOM tam yüklensin diye)

            // Broker verisi yoksa hata vermesin diye boş obje kontrolü
            const safeBrokerData = brokerData || { totalCommission: 0, monthlyCommission: 0, activeClients: 0, accountCount: 0 };

            // --- TABLO SATIRLARINI OLUŞTUR ---
            const transactionRows = latestTransactions.length > 0 ? latestTransactions.map(tx => `
                <tr class="hover:bg-gray-50 border-b border-gray-100 last:border-0">
                    <td class="py-4 px-4 text-sm text-gray-600">${tx.date}</td>
                    <td class="py-4 px-4 text-sm font-medium text-gray-900">${tx.client}</td>
                    <td class="py-4 px-4">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                            ${tx.asset}
                        </span>
                    </td>
                    <td class="py-4 px-4">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${
                            tx.type === 'ALIS' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                        }">
                            ${tx.type}
                        </span>
                    </td>
                    <td class="py-4 px-4 text-sm text-gray-600 text-right">${tx.amount}</td>
                    <td class="py-4 px-4 text-sm text-gray-600 text-right">₺${formatCurrency(tx.price)}</td>
                    <td class="py-4 px-4 text-sm font-bold text-green-600 text-right">₺${formatCurrency(tx.commission)}</td>
                </tr>
            `).join('') : `
                <tr>
                    <td colspan="7" class="py-8 text-center text-gray-500">Henüz görüntülenecek işlem yok.</td>
                </tr>
            `;

            return `
                <div class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                        <div class="bg-white p-6 rounded-xl border border-gray-100 shadow-sm">
                            <div class="flex items-center gap-4">
                                <div class="w-12 h-12 bg-indigo-50 rounded-lg flex items-center justify-center text-indigo-600">${icons.trendingUp}</div>
                                <div><p class="text-sm text-gray-500">Toplam Komisyon</p><h3 class="text-2xl font-bold text-gray-900">₺${formatCurrency(safeBrokerData.totalCommission)}</h3></div>
                            </div>
                        </div>
                         <div class="bg-white p-6 rounded-xl border border-gray-100 shadow-sm">
                            <div class="flex items-center gap-4">
                                <div class="w-12 h-12 bg-green-50 rounded-lg flex items-center justify-center text-green-600">${icons.dollarSign}</div>
                                <div><p class="text-sm text-gray-500">Bu Ay Komisyon</p><h3 class="text-2xl font-bold text-gray-900">₺${formatCurrency(safeBrokerData.monthlyCommission)}</h3></div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="text-lg font-bold text-gray-900">Komisyon Performansı (Son 6 Ay)</h3>
                        </div>
                        <div id="performanceChart" class="w-full h-[350px]"></div>
                    </div>

                    <div class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
                        <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center bg-gray-50">
                            <h3 class="text-lg font-bold text-gray-900">Son 5 İşlem</h3>
                            <button class="px-4 py-2 bg-indigo-600 text-white text-sm rounded-lg hover:bg-indigo-700 transition-colors flex items-center gap-2">
                                ${icons.download || '<svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>'}
                                Rapor İndir
                            </button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50 border-b border-gray-200">
                                    <tr>
                                        <th class="py-3 px-4 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Tarih & Saat</th>
                                        <th class="py-3 px-4 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Müşteri</th>
                                        <th class="py-3 px-4 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Varlık</th>
                                        <th class="py-3 px-4 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">İşlem Tipi</th>
                                        <th class="py-3 px-4 text-right text-xs font-semibold text-gray-500 uppercase tracking-wider">Miktar</th>
                                        <th class="py-3 px-4 text-right text-xs font-semibold text-gray-500 uppercase tracking-wider">Birim Fiyat</th>
                                        <th class="py-3 px-4 text-right text-xs font-semibold text-gray-500 uppercase tracking-wider">Komisyon</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200 bg-white">
                                    ${transactionRows}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }
//************************************
        function renderBrokerClientManagementTab() {
            const filteredClients = clients.filter(c => 
                c.name.toLowerCase().includes(state.searchQuery.toLowerCase()) ||
                c.email.toLowerCase().includes(state.searchQuery.toLowerCase())
            );


            return `
                

                <div class="space-y-6">
                    <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-200">
                        <div class="relative">
                            <div class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">${icons.search}</div>
                            <input type="text" placeholder="Müşteri ara (isim veya e-posta)..." value="${state.searchQuery}"
                                oninput="updateSearchQuery(event.target.value)"
                                class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent outline-none" />
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-200">
                            <div class="flex items-center gap-3">
                                <div class="w-12 h-12 bg-indigo-100 rounded-xl flex items-center justify-center">${icons.user}</div>
                                <div>
                                    <p class="text-sm text-gray-600">Toplam Müşteri</p>
                                    <p class="text-2xl font-bold text-gray-900">${clients.length}</p>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-200">
                            <div class="flex items-center gap-3">
                                <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center">${icons.dollarSign}</div>
                                <div>
                                    <p class="text-sm text-gray-600">Toplam Hesap</p>
                                    <p class="text-2xl font-bold text-gray-900">${clients.reduce((sum, c) => sum + c.accounts.length, 0)}</p>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-200">
                            <div class="flex items-center gap-3">
                                <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center">${icons.trendingUp}</div>
                                <div>
                                    <p class="text-sm text-gray-600">Toplam Varlık</p>
                                    <p class="text-2xl font-bold text-gray-900">₺${formatCurrency(clients.reduce((sum, c) => sum + c.accounts.reduce((acc, a) => acc + a.balance, 0), 0))}</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="space-y-4">
                        ${filteredClients.map(client => `
                            <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                                <div class="p-6 cursor-pointer hover:bg-gray-50 transition-colors" onclick="toggleClient(${client.id})">
                                    <div class="flex items-start justify-between">
                                        <div class="flex items-start gap-4">
                                            <div class="w-14 h-14 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-xl flex items-center justify-center text-white flex-shrink-0">
                                                <span class="text-xl font-bold">${client.name.charAt(0)}</span>
                                            </div>
                                            <div>
                                                <h3 class="text-lg font-bold text-gray-900 mb-2">${client.name}</h3>
                                                <div class="flex flex-col gap-1">
                                                    <div class="flex items-center gap-2 text-sm text-gray-600">
                                                        <div class="w-4 h-4">${icons.phone}</div>
                                                        <span>${client.phone}</span>
                                                    </div>
                                                    <div class="flex items-center gap-2 text-sm text-gray-600">
                                                        <div class="w-4 h-4">${icons.mail}</div>
                                                        <span>${client.email}</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="text-right">
                                            <p class="text-sm text-gray-600 mb-1">${client.accounts.length} Hesap</p>
                                            <p class="text-xl font-bold text-gray-900">₺${formatCurrency(client.accounts.reduce((sum, acc) => sum + acc.balance, 0))}</p>
                                        </div>
                                    </div>
                                </div>

                                ${state.selectedClient === client.id ? `
                                    <div class="border-t border-gray-200 bg-gray-50 p-6">
                                        <div class="mb-6">
                                            <div class="flex items-center gap-2 mb-3">
                                                ${icons.shield}
                                                <h4 class="text-lg font-bold text-gray-900">Risk Profili</h4>
                                            </div>
                                            <div class="bg-white rounded-lg p-4 border border-gray-200">
                                                <div class="flex items-center justify-between mb-2">
                                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium border ${getRiskColor(client.riskProfile.name)}">${client.riskProfile.name}</span>
                                                    <span class="text-sm text-gray-600">Max Hisse Oranı: <span class="font-semibold text-gray-900">%${client.riskProfile.maxStockRatio}</span></span>
                                                </div>
                                                <p class="text-sm text-gray-600">${client.riskProfile.description}</p>
                                            </div>
                                        </div>

                                        <div>
                                            <div class="flex items-center gap-2 mb-3">
                                                ${icons.dollarSign}
                                                <h4 class="text-lg font-bold text-gray-900">Hesaplar</h4>
                                            </div>
                                            <div class="space-y-3">
                                                ${client.accounts.map(acc => `
                                                    <div class="bg-white rounded-lg p-4 border border-gray-200">
                                                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                                            <div>
                                                                <p class="text-xs text-gray-500 mb-1">Hesap No</p>
                                                                <p class="text-sm font-medium text-gray-900">${acc.accountId}</p>
                                                            </div>
                                                            <div>
                                                                <p class="text-xs text-gray-500 mb-1">Bakiye</p>
                                                                <p class="text-sm font-medium text-gray-900">₺${formatCurrency(acc.balance)}</p>
                                                            </div>
                                                            <div>
                                                                <p class="text-xs text-gray-500 mb-1">Komisyon Planı</p>
                                                                <p class="text-sm font-medium text-gray-900">${acc.commissionPlan}</p>
                                                                <p class="text-xs text-gray-500">Min: ₺${acc.minCommission}</p>
                                                            </div>
                                                            <div>
                                                                <p class="text-xs text-gray-500 mb-1">Açılış Tarihi</p>
                                                                <p class="text-sm font-medium text-gray-900">${acc.openDate}</p>
                                                            </div>
                                                        </div>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        </div>

                                        <div class="mt-4 pt-4 border-t border-gray-100">
                                            <button onclick="openClientModal('${client.id}')" class="w-full lg:w-auto bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700 transition-colors flex items-center justify-center gap-2 font-medium">
                                                <span>Müşteri Detaylarını Görüntüle</span>
                                                    ${icons.chevronRight}
                                            </button>
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        `).join('')}
                    </div>

                    ${filteredClients.length === 0 ? `
                        <div class="bg-white rounded-xl p-12 text-center shadow-sm border border-gray-200">
                            ${icons.user}
                            <p class="text-gray-600 mt-3">Müşteri bulunamadı</p>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        //--------------------------------------------------------
       function renderBrokerNewTransactionTab() {
            // 1. SEÇİLİ HESAP VE PORTFÖYÜNÜ BUL
            const selectedAccId = state.transactionForm.selectedAccount;
            let accountHoldings = [];
            
            if (selectedAccId && clients.length > 0) {
                for (const c of clients) {
                    if (c.accounts) {
                        const acc = c.accounts.find(a => String(a.accountId) === String(selectedAccId));
                        if (acc && acc.holdings) {
                            accountHoldings = acc.holdings;
                        }
                    }
                }
            }

            // 2. YEDEK VARLIK LİSTESİ (Hata önleyici)
            let displayAssets = assets;
            if (!assets || assets.length === 0) {
                displayAssets = []; // Boşsa boş kalsın, "Yükleniyor" deriz
            }

            // 3. DROPDOWN HTML
            let assetOptionsHtml = '<option value="">Varlık seçiniz...</option>';
            
            if (state.transactionForm.transactionType === 'ALIS') {
                // ALIŞ: Piyasayı Göster
                if(displayAssets.length > 0) {
                    assetOptionsHtml += displayAssets.map(asset => `
                        <option value="${asset.id}" ${state.transactionForm.selectedAsset === asset.id ? 'selected' : ''}>
                            ${asset.id} - ${asset.name}
                        </option>
                    `).join('');
                } else {
                    assetOptionsHtml += '<option>Veriler Yükleniyor...</option>';
                }
            } else {
                // SATIŞ: Portföyü Göster
                if (accountHoldings.length > 0) {
                    assetOptionsHtml += accountHoldings.map(h => `
                        <option value="${h.assetName}" ${state.transactionForm.selectedAsset === h.assetName ? 'selected' : ''}>
                            ${h.assetName} (Adet: ${h.quantity})
                        </option>
                    `).join('');
                } else {
                    assetOptionsHtml += '<option disabled value="">Satılabilecek varlık yok</option>';
                }
            }

            // 4. SEÇİLİ VARLIK BİLGİSİ BULMA (MAVI KUTU İÇİN)
            let currentAssetInfo = null;
            if (state.transactionForm.selectedAsset) {
                 const selectedVal = state.transactionForm.selectedAsset;
                 
                 // GELİŞMİŞ ARAMA MANTIĞI
                 currentAssetInfo = displayAssets.find(a => 
                    a.id === selectedVal || 
                    a.name === selectedVal || 
                    selectedVal.includes(a.name) || // Veritabanı adı piyasa adını içeriyor mu?
                    a.name.includes(selectedVal)
                 );
            }

            // 5. HESAPLAMALAR
            const calculateTotal = () => {
                const qty = parseFloat(state.transactionForm.amount) || 0;
                const price = parseFloat(state.transactionForm.unitPrice) || 0;
                return qty * price;
            };
            const total = calculateTotal();
            const commission = total * 0.01;
            const netTotal = state.transactionForm.transactionType === 'ALIS' ? (total + commission) : (total - commission);

            // --- HTML ÇIKTISI ---
            return `
                <div class="max-w-4xl mx-auto space-y-6">
                    ${state.showSuccess ? `
                        <div class="bg-green-50 border border-green-200 rounded-xl p-4 flex items-center gap-3">
                            ${icons.checkCircle}
                            <div><p class="font-semibold text-green-900">İşlem başarıyla kaydedildi!</p></div>
                        </div>
                    ` : ''}

                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                        <div class="bg-gradient-to-r from-indigo-600 to-purple-600 px-6 py-4">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 bg-white/20 backdrop-blur-sm rounded-lg flex items-center justify-center">${icons.plus}</div>
                                <h2 class="text-xl font-bold text-white">Yeni İşlem Girişi</h2>
                            </div>
                        </div>

                        <form id="transactionForm" class="p-6 space-y-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Hesap Seçimi</label>
                                <select id="selectedAccount" onchange="handleTransactionFormChange()" required class="w-full px-4 py-3 bg-gray-50 border border-gray-300 rounded-lg outline-none">
                                    <option value="">Hesap seçiniz...</option>
                                    ${accounts.map(acc => `
                                        <option value="${acc.id}" ${String(state.transactionForm.selectedAccount) === String(acc.id) ? 'selected' : ''}>
                                            ${acc.id} - ${acc.clientName} (Bakiye: ₺${formatCurrency(acc.balance)})
                                        </option>
                                    `).join('')}
                                </select>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">İşlem Tipi</label>
                                <div class="grid grid-cols-2 gap-4">
                                    <button type="button" onclick="setTransactionType('ALIS')" 
                                        class="p-4 rounded-lg border-2 transition-all ${state.transactionForm.transactionType === 'ALIS' ? 'border-green-500 bg-green-50' : 'border-gray-200 bg-white'}">
                                        <span class="font-medium ${state.transactionForm.transactionType === 'ALIS' ? 'text-green-900' : 'text-gray-700'}">Alış</span>
                                    </button>
                                    <button type="button" onclick="setTransactionType('SATIS')" 
                                        class="p-4 rounded-lg border-2 transition-all ${state.transactionForm.transactionType === 'SATIS' ? 'border-red-500 bg-red-50' : 'border-gray-200 bg-white'}">
                                        <span class="font-medium ${state.transactionForm.transactionType === 'SATIS' ? 'text-red-900' : 'text-gray-700'}">Satış</span>
                                    </button>
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Varlık Seçimi</label>
                                <select id="selectedAsset" onchange="handleTransactionFormChange()" required class="w-full px-4 py-3 bg-gray-50 border border-gray-300 rounded-lg outline-none">
                                    ${assetOptionsHtml}
                                </select>
                                
                                ${currentAssetInfo ? `
                                    <div class="mt-3 p-4 bg-blue-50 border border-blue-100 rounded-lg flex items-center justify-between">
                                        <div>
                                            <p class="text-sm text-blue-800 font-medium">Piyasa Fiyatı (${currentAssetInfo.id})</p>
                                            <p class="text-xs text-blue-600">${currentAssetInfo.name}</p>
                                        </div>
                                        <div class="text-right">
                                            <p class="text-xl font-bold text-blue-900">₺${currentAssetInfo.currentPrice.toFixed(2)}</p>
                                        </div>
                                    </div>
                                ` : ''}
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Miktar</label>
                                    <input type="number" id="amount" 
                                           value="${state.transactionForm.amount}" 
                                           oninput="handleTransactionFormChange()" 
                                           required class="w-full px-4 py-3 bg-gray-50 border border-gray-300 rounded-lg outline-none" />
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Birim Fiyat</label>
                                    <input type="number" id="unitPrice" 
                                           value="${state.transactionForm.unitPrice}" 
                                           oninput="handleTransactionFormChange()" 
                                           required class="w-full px-4 py-3 bg-gray-50 border border-gray-300 rounded-lg outline-none" />
                                </div>
                            </div>

                            <div id="summary-section" class="bg-gray-50 p-4 rounded-lg border border-gray-200 ${total > 0 ? '' : 'hidden'}">
                                <div class="flex justify-between text-sm mb-2">
                                    <span class="text-gray-600">Ara Toplam:</span>
                                    <span id="summary-total" class="font-medium">₺${formatCurrency(total)}</span>
                                </div>
                                <div class="flex justify-between text-sm mb-2">
                                    <span class="text-gray-600">Komisyon (%1):</span>
                                    <span id="summary-commission" class="font-medium text-gray-900">₺${formatCurrency(commission)}</span>
                                </div>
                                <div class="flex justify-between text-lg font-bold border-t border-gray-300 pt-2 mt-2">
                                    <span class="text-gray-900">Toplam:</span>
                                    <span id="summary-net" class="text-indigo-700">₺${formatCurrency(netTotal)}</span>
                                </div>
                            </div>

                            <button type="submit" class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white py-4 rounded-lg font-medium shadow-lg">
                                İşlemi Kaydet
                            </button>
                        </form>
                    </div>
                </div>
            `;
        }
        //********************************************************
        function renderBrokerInterface() {
            const tabs = [
                { id: 'performance', label: 'Genel Bakış / Performans', icon: icons.barChart3 },
                { id: 'clients', label: 'Müşteri Yönetimi', icon: icons.users },
                { id: 'transaction', label: 'Yeni İşlem Girişi', icon: icons.plus }
            ];

            return `
                <div class="min-h-screen bg-gray-50">
                    <header class="bg-white border-b border-gray-200 sticky top-0 z-10 shadow-sm">
                        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                            <div class="flex items-center justify-between h-16">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 bg-gradient-to-br from-indigo-600 to-purple-600 rounded-xl flex items-center justify-center">
                                        ${icons.briefcase}
                                    </div>
                                    <div>
                                        <h1 class="text-xl font-bold text-gray-900">Broker Paneli</h1>
                                        <p class="text-sm text-gray-500">${state.currentUser.name} ${state.currentUser.surname}</p>
                                    </div>
                                </div>
                                <button onclick="logout()" class="flex items-center gap-2 px-4 py-2 text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded-lg transition-colors">
                                    ${icons.logOut}
                                    <span>Çıkış</span>
                                </button>
                            </div>
                        </div>
                    </header>

                    <div class="bg-white border-b border-gray-200 shadow-sm">
                        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                            <nav class="flex gap-8 overflow-x-auto">
                                ${tabs.map(tab => `
                                    <button onclick="setTab('${tab.id}')" 
                                        class="flex items-center gap-2 py-4 px-2 border-b-2 transition-colors whitespace-nowrap ${state.currentTab === tab.id ? 'border-indigo-600 text-indigo-600' : 'border-transparent text-gray-500 hover:text-gray-700'}">
                                        ${tab.icon}
                                        <span class="font-medium">${tab.label}</span>
                                    </button>
                                `).join('')}
                            </nav>
                        </div>
                    </div>

                    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                        ${state.currentTab === 'performance' ? renderBrokerPerformanceTab() : ''}
                        ${state.currentTab === 'clients' ? renderBrokerClientManagementTab() : ''}
                        ${state.currentTab === 'transaction' ? renderBrokerNewTransactionTab() : ''}
                    </main>
                </div>
            `;
        }
        // Filtreleri Temizleme Fonksiyonu (Yeni Ekledim)
        function clearFilters() {
            state.filterState = {
                selectedAccount: 'all',
                selectedType: 'all',
                dateFrom: '',
                dateTo: ''
            };
            render();
        }

       function renderInvestorAccountsTab() {
            // Veri güvenliği: investorInfo henüz yüklenmediyse hata vermesin
            const risk = (investorInfo && investorInfo.riskProfile) ? investorInfo.riskProfile : { name: 'Belirlenmedi', desc: 'Veri yükleniyor...', maxStock: 0 };
            const broker = (investorInfo && investorInfo.broker) ? investorInfo.broker : { name: '-', email: '-', phone: '-', initial: '?' };

            // --- HTML ÇIKTISI ---
            return `
                <div class="space-y-8">
                    
                    <div class="flex flex-col md:flex-row justify-between items-center bg-gradient-to-r from-gray-900 to-gray-800 p-6 rounded-2xl text-white shadow-lg">
                        <div>
                            <h2 class="text-2xl font-bold">Hesaplarım</h2>
                            <p class="text-gray-400 text-sm mt-1">Tüm yatırım hesaplarınızı buradan yönetebilirsiniz.</p>
                        </div>
                        <button onclick="openNewAccountModal()" class="mt-4 md:mt-0 bg-blue-600 hover:bg-blue-500 text-white px-6 py-3 rounded-xl font-bold shadow-lg transition-all flex items-center gap-2 transform hover:-translate-y-0.5">
                            ${icons.plus}
                            Yeni Hesap Aç
                        </button>
                    </div>

                    <div class="space-y-6">
                        ${(!accounts || accounts.length === 0) 
                            ? `<div class="p-12 text-center bg-white rounded-xl border border-gray-200">
                                ${icons.creditCard}
                                <h3 class="mt-4 text-lg font-bold text-gray-900">Hesap Bulunamadı</h3>
                                <p class="text-gray-500">Henüz aktif bir yatırım hesabınız yok. Yukarıdaki butondan oluşturabilirsiniz.</p>
                               </div>`
                            : accounts.map(acc => `
                            
                            <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-200 hover:shadow-md transition-shadow">
                                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-8">
                                    <div class="flex items-center gap-4">
                                        <div class="w-14 h-14 bg-blue-50 rounded-2xl flex items-center justify-center text-blue-600 shadow-sm border border-blue-100">
                                            ${icons.creditCard}
                                        </div>
                                        <div>
                                            <h3 class="text-lg font-bold text-gray-900">Hesap No: ${acc.id}</h3>
                                            <p class="text-sm text-gray-500">Yatırım Hesabı</p>
                                        </div>
                                    </div>
                                    <div class="text-left md:text-right">
                                        <p class="text-xs text-gray-500 mb-1 font-medium uppercase tracking-wide">Mevcut Bakiye</p>
                                        <h3 class="text-3xl font-bold text-gray-900">₺${formatCurrency(acc.balance)}</h3>
                                    </div>
                                </div>

                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                                    <div class="bg-gray-50 rounded-xl p-4 border border-gray-100">
                                        <div class="flex items-center gap-2 mb-2">
                                            <div class="w-4 h-4 text-gray-400">${icons.calendar}</div>
                                            <span class="text-xs font-semibold text-gray-500 uppercase">Açılış Tarihi</span>
                                        </div>
                                        <p class="font-medium text-gray-900 text-lg">${acc.openDate}</p>
                                    </div>
                                    <div class="bg-gray-50 rounded-xl p-4 border border-gray-100">
                                        <div class="flex items-center gap-2 mb-2">
                                            <div class="w-4 h-4 text-gray-400">${icons.dollarSign}</div>
                                            <span class="text-xs font-semibold text-gray-500 uppercase">Komisyon Planı</span>
                                        </div>
                                        <p class="font-medium text-gray-900 text-lg">${acc.commissionPlan}</p>
                                        <p class="text-xs text-gray-400 mt-1">Min: ₺${acc.minCommission}</p>
                                    </div>
                                    <div class="bg-gray-50 rounded-xl p-4 border border-gray-100">
                                        <div class="flex items-center gap-2 mb-2">
                                            <div class="w-4 h-4 text-gray-400">${icons.shield}</div>
                                            <span class="text-xs font-semibold text-gray-500 uppercase">Durum</span>
                                        </div>
                                        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium ${
                                            acc.status === 'Aktif' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'
                                        }">
                                            ${acc.status || 'Pasif'}
                                        </span>
                                    </div>
                                </div>

                                <div class="pt-2">
                                    <button onclick="toggleAccountStatus('${acc.id}')" 
                                        class="w-full py-3 px-6 rounded-lg text-sm font-medium transition-colors border flex items-center justify-center gap-2 ${
                                        acc.status === 'Aktif' ? 'border-red-200 text-red-600 hover:bg-red-50 bg-white' : 'bg-green-600 text-white hover:bg-green-700'
                                    }">
                                        ${acc.status === 'Aktif' ? 'Hesabı Dondur' : 'Hesabı Aktifleştir'}
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>

                    <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-200">
                        <div class="flex items-center gap-2 mb-4">
                            <div class="text-gray-600">${icons.shield}</div>
                            <h3 class="text-lg font-bold text-gray-900">Risk Profili</h3>
                        </div>
                        <div class="bg-gray-50 rounded-xl p-6 border border-gray-100">
                            <div class="flex justify-between items-center mb-3">
                                <span class="px-4 py-1.5 rounded-full text-sm font-bold bg-yellow-100 text-yellow-800 border border-yellow-200 shadow-sm">
                                    ${risk.name}
                                </span>
                                <span class="text-sm text-gray-500 font-medium">Maksimum Hisse Oranı: <span class="text-gray-900 font-bold">%${risk.maxStock}</span></span>
                            </div>
                            <p class="text-gray-600 text-sm leading-relaxed">${risk.desc}</p>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-200">
                        <div class="flex items-center gap-2 mb-6">
                            <div class="text-gray-600">${icons.user}</div>
                            <h3 class="text-lg font-bold text-gray-900">Sorumlu Broker</h3>
                        </div>
                        <div class="flex flex-col md:flex-row items-start gap-6">
                            <div class="w-16 h-16 bg-purple-600 rounded-2xl flex items-center justify-center text-white text-2xl font-bold shadow-md flex-shrink-0">
                                ${broker.initial}
                            </div>
                            <div class="w-full">
                                <h4 class="text-lg font-bold text-gray-900 mb-4">${broker.name}</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div class="bg-gray-50 p-4 rounded-xl border border-gray-100">
                                        <p class="text-xs text-gray-500 mb-1 font-semibold uppercase">Telefon</p>
                                        <p class="text-gray-900 font-medium">${broker.phone}</p>
                                    </div>
                                    <div class="bg-gray-50 p-4 rounded-xl border border-gray-100">
                                        <p class="text-xs text-gray-500 mb-1 font-semibold uppercase">E-posta</p>
                                        <p class="text-gray-900 font-medium break-all">${broker.email}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        function renderInvestorTransactionHistoryTab() {
            // Veri yoksa boş dizi ata
            const allTransactions = transactions || [];

            // --- 1. KARTLAR İÇİN HESAPLAMA (TÜM VERİDEN) ---
            // Filtrelerden etkilenmemesi için 'allTransactions' kullanıyoruz
            const totalBuy = allTransactions
                .filter(t => t.type === 'ALIS')
                .reduce((sum, t) => sum + (t.netTotal || 0), 0);
                
            const totalSell = allTransactions
                .filter(t => t.type === 'SATIS')
                .reduce((sum, t) => sum + (t.netTotal || 0), 0);
                
            const totalCommission = allTransactions
                .reduce((sum, t) => sum + (t.commission || 0), 0);


            // --- 2. TABLO İÇİN FİLTRELEME ---
            const filteredTransactions = allTransactions.filter(t => {
                // Hesap Filtresi
                if (state.filterState.selectedAccount !== 'all' && String(t.accountId) !== String(state.filterState.selectedAccount)) return false;
                
                // Tip Filtresi
                if (state.filterState.selectedType !== 'all' && t.type !== state.filterState.selectedType) return false;
                
                // Tarih Filtresi
                if (state.filterState.dateFrom) {
                    const tDate = new Date(t.date); // İşlem tarihi
                    const fDate = new Date(state.filterState.dateFrom); // Başlangıç
                    fDate.setHours(0, 0, 0, 0); // Saat farkını yok say
                    if (tDate < fDate) return false;
                }
                if (state.filterState.dateTo) {
                    const tDate = new Date(t.date);
                    const fDate = new Date(state.filterState.dateTo);
                    fDate.setHours(23, 59, 59, 999); // Günün sonuna kadar
                    if (tDate > fDate) return false;
                }
                return true;
            });

            return `
                <div class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-200">
                            <div class="flex items-center gap-3 mb-2">
                                <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center">${icons.trendingUp}</div>
                                <div><p class="text-sm text-gray-600">Toplam Alış (Tümü)</p><p class="text-xl font-bold text-gray-900">₺${formatCurrency(totalBuy)}</p></div>
                            </div>
                        </div>
                        <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-200">
                            <div class="flex items-center gap-3 mb-2">
                                <div class="w-10 h-10 bg-red-100 rounded-lg flex items-center justify-center">${icons.trendingDown}</div>
                                <div><p class="text-sm text-gray-600">Toplam Satış (Tümü)</p><p class="text-xl font-bold text-gray-900">₺${formatCurrency(totalSell)}</p></div>
                            </div>
                        </div>
                        <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-200">
                            <div class="flex items-center gap-3 mb-2">
                                <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">${icons.calendar}</div>
                                <div><p class="text-sm text-gray-600">Toplam Komisyon (Tümü)</p><p class="text-xl font-bold text-gray-900">₺${formatCurrency(totalCommission)}</p></div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-200">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center gap-2">
                                ${icons.filter} <h3 class="text-xl font-bold text-gray-900">Filtrele</h3>
                            </div>
                            <button onclick="clearFilters()" class="text-sm text-indigo-600 hover:text-indigo-800 font-medium">Filtreleri Temizle</button>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Hesap</label>
                                <select id="filterAccount" onchange="handleFilterChange()" class="w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg outline-none">
                                    <option value="all">Tüm Hesaplar</option>
                                    ${accounts ? accounts.map(acc => `<option value="${acc.id}" ${state.filterState.selectedAccount == acc.id ? 'selected' : ''}>${acc.id}</option>`).join('') : ''}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">İşlem Tipi</label>
                                <select id="filterType" onchange="handleFilterChange()" class="w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg outline-none">
                                    <option value="all" ${state.filterState.selectedType === 'all' ? 'selected' : ''}>Tümü</option>
                                    <option value="ALIS" ${state.filterState.selectedType === 'ALIS' ? 'selected' : ''}>Alış</option>
                                    <option value="SATIS" ${state.filterState.selectedType === 'SATIS' ? 'selected' : ''}>Satış</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Başlangıç</label>
                                <input type="date" id="filterDateFrom" onchange="handleFilterChange()" value="${state.filterState.dateFrom}" class="w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg outline-none" />
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Bitiş</label>
                                <input type="date" id="filterDateTo" onchange="handleFilterChange()" value="${state.filterState.dateTo}" class="w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg outline-none" />
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                        <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
                            <h3 class="text-xl font-bold text-gray-900">İşlem Geçmişi (${filteredTransactions.length} kayıt)</h3>
                            <button class="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm font-medium">${icons.download}<span>Dışa Aktar</span></button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600">Tarih & Saat</th>
                                        <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600">Varlık</th>
                                        <th class="px-6 py-3 text-center text-xs font-semibold text-gray-600">İşlem</th>
                                        <th class="px-6 py-3 text-right text-xs font-semibold text-gray-600">Miktar</th>
                                        <th class="px-6 py-3 text-right text-xs font-semibold text-gray-600">Birim Fiyat</th>
                                        <th class="px-6 py-3 text-right text-xs font-semibold text-gray-600">Tutar</th>
                                        <th class="px-6 py-3 text-right text-xs font-semibold text-gray-600">Komisyon</th>
                                        <th class="px-6 py-3 text-right text-xs font-semibold text-gray-600">Net Tutar</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200">
                                    ${filteredTransactions.map(t => `
                                        <tr class="hover:bg-gray-50 transition-colors">
                                            <td class="px-6 py-4 text-sm text-gray-600 whitespace-nowrap">${t.date}</td>
                                            <td class="px-6 py-4"><p class="text-sm font-medium text-gray-900">${t.asset}</p><p class="text-xs text-gray-500">${t.assetName || ''}</p></td>
                                            <td class="px-6 py-4 text-center"><span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${t.type === 'ALIS' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">${t.type}</span></td>
                                            <td class="px-6 py-4 text-right text-sm text-gray-900">${t.amount}</td>
                                            <td class="px-6 py-4 text-right text-sm text-gray-900">₺${(t.unitPrice || 0).toFixed(2)}</td>
                                            <td class="px-6 py-4 text-right text-sm text-gray-900">₺${(t.total || 0).toFixed(2)}</td>
                                            <td class="px-6 py-4 text-right text-sm text-gray-600">₺${(t.commission || 0).toFixed(2)}</td>
                                            <td class="px-6 py-4 text-right text-sm font-semibold text-gray-900">₺${(t.netTotal || 0).toFixed(2)}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                        ${filteredTransactions.length === 0 ? `<div class="p-12 text-center text-gray-500">Kriterlere uygun kayıt bulunamadı</div>` : ''}
                    </div>
                </div>
            `;
        }
        function renderInvestorPortfolioTab() {
            const totalCost = portfolioPositions.reduce((sum, p) => sum + p.totalCost, 0);
            const totalCurrentValue = portfolioPositions.reduce((sum, p) => sum + p.currentValue, 0);
            const totalProfitLoss = totalCurrentValue - totalCost;
            const totalProfitLossPercent = (totalProfitLoss / totalCost) * 100;

            return `
                <div class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                        <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-200">
                            <div class="flex items-center gap-3 mb-2">
                                <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">${icons.package}</div>
                                <div>
                                    <p class="text-sm text-gray-600">Pozisyon Sayısı</p>
                                    <p class="text-2xl font-bold text-gray-900">${portfolioPositions.length}</p>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-200">
                            <div class="flex items-center gap-3 mb-2">
                                <div class="w-10 h-10 bg-indigo-100 rounded-lg flex items-center justify-center">${icons.dollarSign}</div>
                                <div>
                                    <p class="text-sm text-gray-600">Toplam Maliyet</p>
                                    <p class="text-2xl font-bold text-gray-900">₺${formatCurrency(totalCost)}</p>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-200">
                            <div class="flex items-center gap-3 mb-2">
                                <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center">${icons.pieChart}</div>
                                <div>
                                    <p class="text-sm text-gray-600">Güncel Değer</p>
                                    <p class="text-2xl font-bold text-gray-900">₺${formatCurrency(totalCurrentValue)}</p>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-200">
                            <div class="flex items-center gap-3 mb-2">
                                <div class="w-10 h-10 ${totalProfitLoss >= 0 ? 'bg-green-100' : 'bg-red-100'} rounded-lg flex items-center justify-center">
                                    <div class="${totalProfitLoss >= 0 ? 'text-green-600' : 'text-red-600'}">${icons.trendingUp}</div>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-600">Kar/Zarar</p>
                                    <p class="text-2xl font-bold ${totalProfitLoss >= 0 ? 'text-green-600' : 'text-red-600'}">
                                        ${totalProfitLoss >= 0 ? '+' : ''}₺${formatCurrency(totalProfitLoss)}
                                    </p>
                                    <p class="text-xs ${totalProfitLoss >= 0 ? 'text-green-600' : 'text-red-600'}">
                                        ${totalProfitLoss >= 0 ? '+' : ''}%${totalProfitLossPercent.toFixed(2)}
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                        <div class="px-6 py-4 border-b border-gray-200">
                            <h3 class="text-xl font-bold text-gray-900">Portföy Pozisyonları</h3>
                        </div>

                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600">Varlık</th>
                                        <th class="px-6 py-3 text-right text-xs font-semibold text-gray-600">Miktar</th>
                                        <th class="px-6 py-3 text-right text-xs font-semibold text-gray-600">Ort. Maliyet</th>
                                        <th class="px-6 py-3 text-right text-xs font-semibold text-gray-600">Toplam Maliyet</th>
                                        <th class="px-6 py-3 text-right text-xs font-semibold text-gray-600">Güncel Fiyat</th>
                                        <th class="px-6 py-3 text-right text-xs font-semibold text-gray-600">Güncel Değer</th>
                                        <th class="px-6 py-3 text-right text-xs font-semibold text-gray-600">Kar/Zarar</th>
                                        <th class="px-6 py-3 text-right text-xs font-semibold text-gray-600">%</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200">
                                    ${portfolioPositions.map(p => `
                                        <tr class="hover:bg-gray-50 transition-colors">
                                            <td class="px-6 py-4">
                                                <p class="text-sm font-medium text-gray-900">${p.assetId}</p>
                                                <p class="text-xs text-gray-500">${p.assetName}</p>
                                            </td>
                                            <td class="px-6 py-4 text-right text-sm text-gray-900">${formatCurrency(p.currentAmount)}</td>
                                            <td class="px-6 py-4 text-right text-sm text-gray-900">₺${p.avgBuyPrice.toFixed(2)}</td>
                                            <td class="px-6 py-4 text-right text-sm text-gray-900">₺${formatCurrency(p.totalCost)}</td>
                                            <td class="px-6 py-4 text-right text-sm text-gray-900">₺${p.currentPrice.toFixed(2)}</td>
                                            <td class="px-6 py-4 text-right text-sm text-gray-900">₺${formatCurrency(p.currentValue)}</td>
                                            <td class="px-6 py-4 text-right text-sm font-semibold ${p.profitLoss >= 0 ? 'text-green-600' : 'text-red-600'}">
                                                ${p.profitLoss >= 0 ? '+' : ''}₺${formatCurrency(p.profitLoss)}
                                            </td>
                                            <td class="px-6 py-4 text-right text-sm font-semibold ${p.profitLoss >= 0 ? 'text-green-600' : 'text-red-600'}">
                                                ${p.profitLoss >= 0 ? '+' : ''}%${p.profitLossPercent.toFixed(2)}
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                                <tfoot class="bg-gray-50 border-t-2 border-gray-300">
                                    <tr>
                                        <td class="px-6 py-4 text-sm font-bold text-gray-900">Toplam</td>
                                        <td class="px-6 py-4"></td>
                                        <td class="px-6 py-4"></td>
                                        <td class="px-6 py-4 text-right text-sm font-bold text-gray-900">₺${formatCurrency(totalCost)}</td>
                                        <td class="px-6 py-4"></td>
                                        <td class="px-6 py-4 text-right text-sm font-bold text-gray-900">₺${formatCurrency(totalCurrentValue)}</td>
                                        <td class="px-6 py-4 text-right text-sm font-bold ${totalProfitLoss >= 0 ? 'text-green-600' : 'text-red-600'}">
                                            ${totalProfitLoss >= 0 ? '+' : ''}₺${formatCurrency(totalProfitLoss)}
                                        </td>
                                        <td class="px-6 py-4 text-right text-sm font-bold ${totalProfitLoss >= 0 ? 'text-green-600' : 'text-red-600'}">
                                            ${totalProfitLoss >= 0 ? '+' : ''}%${totalProfitLossPercent.toFixed(2)}
                                        </td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-200">
                        <h3 class="text-xl font-bold text-gray-900 mb-6">Portföy Dağılımı</h3>
                        <div class="space-y-4">
                            ${portfolioPositions.map(p => {
                                const percentage = (p.currentValue / totalCurrentValue) * 100;
                                return `
                                    <div>
                                        <div class="flex items-center justify-between mb-2">
                                            <div class="flex items-center gap-3">
                                                <span class="text-sm font-semibold text-gray-900">${p.assetId}</span>
                                                <span class="text-xs text-gray-500">${p.assetName}</span>
                                            </div>
                                            <div class="text-right">
                                                <span class="text-sm font-semibold text-gray-900">%${percentage.toFixed(2)}</span>
                                                <span class="text-xs text-gray-500 ml-2">₺${formatCurrency(p.currentValue)}</span>
                                            </div>
                                        </div>
                                        <div class="w-full bg-gray-200 rounded-full h-2">
                                            <div class="bg-gradient-to-r from-blue-500 to-indigo-600 h-2 rounded-full transition-all" style="width: ${percentage}%"></div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderInvestorInterface() {
            const tabs = [
                { id: 'accounts', label: 'Hesaplarım ve Bakiye', icon: icons.wallet },
                { id: 'history', label: 'İşlem Geçmişi', icon: icons.receipt },
                { id: 'portfolio', label: 'Portföy Durumu', icon: icons.pieChart }
            ];

            return `
                <div class="min-h-screen bg-gray-50">
                    <header class="bg-white border-b border-gray-200 sticky top-0 z-10 shadow-sm">
                        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                            <div class="flex items-center justify-between h-16">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 bg-gradient-to-br from-blue-600 to-indigo-600 rounded-xl flex items-center justify-center">
                                        ${icons.wallet}
                                    </div>
                                    <div>
                                        <h1 class="text-xl font-bold text-gray-900">Yatırımcı Paneli</h1>
                                        <p class="text-sm text-gray-500">${state.currentUser.name} ${state.currentUser.surname}</p>
                                    </div>
                                </div>
                                <button onclick="logout()" class="flex items-center gap-2 px-4 py-2 text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded-lg transition-colors">
                                    ${icons.logOut}
                                    <span>Çıkış</span>
                                </button>
                            </div>
                        </div>
                    </header>

                    <div class="bg-white border-b border-gray-200 shadow-sm">
                        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                            <nav class="flex gap-8 overflow-x-auto">
                                ${tabs.map(tab => `
                                    <button onclick="setTab('${tab.id}')" 
                                        class="flex items-center gap-2 py-4 px-2 border-b-2 transition-colors whitespace-nowrap ${state.currentTab === tab.id ? 'border-blue-600 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'}">
                                        ${tab.icon}
                                        <span class="font-medium">${tab.label}</span>
                                    </button>
                                `).join('')}
                            </nav>
                        </div>
                    </div>

                    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                        ${state.currentTab === 'accounts' ? renderInvestorAccountsTab() : ''}
                        ${state.currentTab === 'history' ? renderInvestorTransactionHistoryTab() : ''}
                        ${state.currentTab === 'portfolio' ? renderInvestorPortfolioTab() : ''}
                    </main>
                </div>
            `;
        }

        // Event Handlers--chate attım
        // ESKİ handleLogin fonksiyonunu sil ve YERİNE BUNU YAPIŞTIR:

        async function handleLogin(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const userType = document.getElementById('userType').value;

            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalBtnText = submitBtn.innerText;
            submitBtn.disabled = true;
            submitBtn.innerText = 'Kontrol ediliyor...';

            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: username,
                        password: password,
                        userType: userType
                    })
                });

                const data = await response.json();

                if (data.success) {
                    // 1. State'i güncelle
                    await loadMarketData();
                    state.currentUser = data.user;
                    state.currentScreen = data.user.role; 
                    state.currentTab = data.user.role === 'broker' ? 'performance' : 'accounts';
                    
                    // 2. EKRANI HEMEN DEĞİŞTİR
                    render(); 

                    // 3. Arka planda verileri çekmeye çalış
                    if (state.currentScreen === 'investor') {
                        await loadInvestorData(state.currentUser.id);
                    } else if (state.currentScreen === 'broker') {
                         await loadBrokerData(state.currentUser.id);
                    }
                
                } // <--- DÜZELTME BURADA: Bu parantez eksikti (if data.success bloğunu kapatır)
                else {
                    alert(data.message || 'Giriş başarısız.');
                }

            } catch (error) {
                console.error('Login Hatası:', error);
                alert('Sunucuya bağlanırken bir hata oluştu.');
            } finally {
                if (state.currentScreen === 'login') {
                    submitBtn.disabled = false;
                    submitBtn.innerText = originalBtnText;
                }
            }
        }//burada parantez
//chatle değiştirdik
// --- BU KISMI handleLogin FONKSİYONUNUN ALTINA YAPIŞTIR ---

    function logout() {
        state.currentUser = null;
        state.currentScreen = 'login';
        state.currentTab = null;
        // Eğer brokerData veya investor verilerini sıfırlamak istersen buraya ekleyebilirsin
        render();
    }

    function setTab(tab) {
        state.currentTab = tab;
        render();
    }

    function setPeriod(period) {
        state.selectedPeriod = period;
        render();
    }

//-------------------
        async function handleTransactionSubmit(e) {
            e.preventDefault();

            // Form verilerini al
            const accountId = document.getElementById('selectedAccount').value;
            const assetId = document.getElementById('selectedAsset').value;
            const amount = document.getElementById('amount').value;
            const unitPrice = document.getElementById('unitPrice').value;
            const type = state.transactionForm.transactionType; // 'ALIS' veya 'SATIS'

            if (!accountId || !assetId || !amount || !unitPrice) {
                alert('Lütfen tüm alanları doldurun!');
                return;
            }

            try {
                const response = await fetch('/api/transaction/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        accountId: accountId,
                        assetId: assetId,
                        type: type,
                        amount: amount,
                        price: unitPrice
                    })
                });

                const data = await response.json();

                if (data.success) {
                    alert('İşlem Başarılı!');
                    state.showSuccess = true;
                    // Formu temizle
                    state.transactionForm = { ...state.transactionForm, amount: '', unitPrice: '' };
                    
                    // Verileri güncelle (Bakiyelerin değişmesi için)
                    await loadBrokerData(state.currentUser.id);
                } else {
                    alert('Hata: ' + data.message);
                }
            } catch (error) {
                console.error('İşlem hatası:', error);
                alert('Sunucu hatası.');
            }
        }
        // Filtre Değişimini Yöneten Fonksiyon
        function handleFilterChange() {
            // HTML elemanlarından güncel değerleri al
            const accountVal = document.getElementById('filterAccount').value;
            const typeVal = document.getElementById('filterType').value;
            const dateFromVal = document.getElementById('filterDateFrom').value;
            const dateToVal = document.getElementById('filterDateTo').value;

            // State'i güncelle
            state.filterState = {
                selectedAccount: accountVal,
                selectedType: typeVal,
                dateFrom: dateFromVal,
                dateTo: dateToVal
            };

            // Sayfayı yeniden çiz (Filtreli tabloyu göster)
            render();
            
            // Render sonrası focus (odak) sorununu çözmek için ufak bir hile:
            // (Tarih seçince kapanmaması için genelde gerekmez ama input'ta gerekebilir)
        }

        // New Account Functions
        function openNewAccountModal() {
            state.showNewAccountModal = true;
            render();
        }

        function closeNewAccountModal() {
            state.showNewAccountModal = false;
            state.newAccountForm = {
                selectedBroker: '',
                initialDeposit: '',
                commissionPlan: 'Standart Plan'
            };
            render();
        }

        function setCommissionPlan(plan) {
            state.newAccountForm.commissionPlan = plan;
            render();
        }

        async function handleNewAccountSubmit(e) {
            e.preventDefault();
            
            const brokerId = document.getElementById('selectedBroker').value;
            const initialDeposit = document.getElementById('initialDeposit').value;
            // Komisyon planı state'den geliyor (butonlarla seçilmişti)
            const commissionPlan = state.newAccountForm.commissionPlan;

            if (!brokerId || !initialDeposit) {
                alert('Lütfen tüm alanları doldurun!');
                return;
            }

            if (parseFloat(initialDeposit) < 10000) {
                alert('Minimum başlangıç yatırımı ₺10.000 olmalıdır!');
                return;
            }

            // Butonu kilitleyelim
            const submitBtn = e.target.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.innerText = 'İşleniyor...';

            try {
                const response = await fetch('/api/account/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        investorId: state.currentUser.id,
                        brokerId: brokerId,
                        initialDeposit: parseFloat(initialDeposit),
                        commissionPlan: commissionPlan
                    })
                });

                const data = await response.json();

                if (data.success) {
                    alert('Yeni hesap başarıyla oluşturuldu!\nHesap No: ' + data.accountId);
                    
                    // Modalı kapat
                    closeNewAccountModal();
                    
                    // LİSTEYİ GÜNCELLE: Veritabanından verileri tekrar çek
                    await loadInvestorData(state.currentUser.id);
                    
                } else {
                    alert('Hata: ' + data.message);
                }

            } catch (error) {
                console.error('Hesap açma hatası:', error);
                alert('Bir hata oluştu.');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerText = 'Hesap Aç';
            }
        }

        // --- HESAP DURUMU DEĞİŞTİRME FONKSİYONU ---
    async function toggleAccountStatus(accountId) {
        // Kullanıcıya soralım
        if(!confirm('Bu hesabın durumunu değiştirmek istediğinize emin misiniz?')) return;

        try {
            const response = await fetch('/api/account/toggle-status', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ accountId: accountId })
            });
            
            const data = await response.json();
            
            if (data.success) {
                // Başarılıysa verileri tazeleyip ekranı yenile
                await loadInvestorData(state.currentUser.id);
                render();
            } else {
                alert("Hata: " + data.message);
            }
        } catch (error) {
            console.error("İstek hatası:", error);
            alert("İşlem sırasında bir hata oluştu.");
        }
    }
//bizekledik
async function loadInvestorData(investorId) {
        try {
            console.log("Veri çekiliyor: ", investorId);
            const response = await fetch(`/api/investor/dashboard/${investorId}`);
            const data = await response.json();

            if (data.success) {
                // 1. Kullanıcı Bilgisi
                if (data.investor) {
                    state.currentUser = { ...state.currentUser, ...data.investor };
                }

                // 2. Risk ve Broker Bilgilerini Kaydet
                // (Hesaplar sekmesinde bu verileri kullanıyoruz)
                investorInfo = {
                    riskProfile: data.riskProfile,
                    broker: data.broker
                };

                // 3. Hesapları Kaydet
                if (data.accounts && Array.isArray(data.accounts)) {
                    accounts = data.accounts.map(acc => ({
                        id: acc.accountNumber,
                        balance: parseFloat(acc.balance),
                        status: acc.status || 'Aktif',
                        openDate: acc.openDate,
                        commissionPlan: acc.commissionPlan,
                        minCommission: acc.minCommission
                    }));
                } else {
                    accounts = [];
                }

                // 4. İşlemleri Kaydet (HEM GEÇMİŞ HEM DASHBOARD İÇİN)
            if (data.transactions) {
                transactions = data.transactions;
                recentTransactions = data.transactions.slice(0, 5);
            } else {
                transactions = [];
                recentTransactions = [];
            }

            // --- YENİ EKLENEN SATIR ---
            // İşlemler geldikten sonra portföyü hesapla
            calculatePortfolio();

                // 5. Ekranı Yenile
                render();
            } else {
                console.error("Veri yüklenemedi:", data.message);
            }
        } catch (error) {
            console.error('Yatırımcı veri hatası:', error);
        }
    }
//biz ekledik

        // Main Render Function
        function render() {
            const app = document.getElementById('app');
            
            if (state.currentScreen === 'login') {
                app.innerHTML = renderLoginScreen();
                document.getElementById('loginForm').addEventListener('submit', handleLogin);
            } else if (state.currentScreen === 'broker') {
                app.innerHTML = renderBrokerInterface();
                
                // Add event listeners for broker forms
                const transactionForm = document.getElementById('transactionForm');
                if (transactionForm) {
                    transactionForm.addEventListener('submit', handleTransactionSubmit);
                    document.getElementById('selectedAccount').addEventListener('change', handleTransactionFormChange);
                    document.getElementById('selectedAsset').addEventListener('change', handleTransactionFormChange);
                    document.getElementById('amount').addEventListener('input', handleTransactionFormChange);
                    document.getElementById('unitPrice').addEventListener('input', handleTransactionFormChange);
                }
            } else if (state.currentScreen === 'investor') {
                app.innerHTML = renderInvestorInterface();
                
                

                // Add event listeners for new account form
                const newAccountForm = document.getElementById('newAccountForm');
                if (newAccountForm) {
                    newAccountForm.addEventListener('submit', handleNewAccountSubmit);
                }
            }
        }

        // Başlangıçta çalışacak kodlar
    (async function init() {
        await loadMarketData(); // Önce piyasa verilerini çek (Fiyatlar için)
        // Login kontrolü veya sayfa yenileme durumları burada yönetilebilir
        render();
    })();
    
// Bu fonksiyon veritabanından gelen işlem geçmişini tarar ve portföyü oluşturur
        function calculatePortfolio() {
            const positions = {};

            // 1. Tüm işlemleri gez ve eldeki hisseleri hesapla
            if (transactions && transactions.length > 0) {
                // İşlemleri tarihe göre sırala (Eskiden yeniye)
                const sortedTrans = [...transactions].sort((a, b) => new Date(a.date) - new Date(b.date));

                sortedTrans.forEach(t => {
                    // Varlık Adı veya Kodunu Anahtar Olarak Kullan (Boşlukları temizle)
                    const assetKey = (t.asset || t.assetName).trim(); 

                    if (!positions[assetKey]) {
                        positions[assetKey] = {
                            assetId: t.asset,      // Örn: AKBNK
                            assetName: t.assetName, // Örn: Akbank T.A.Ş
                            totalAmount: 0,        // Eldeki Adet
                            totalCost: 0           // Toplam Maliyet
                        };
                    }

                    if (t.type === 'ALIS') {
                        positions[assetKey].totalAmount += t.amount;
                        positions[assetKey].totalCost += t.netTotal; 
                    } 
                    else if (t.type === 'SATIS') {
                        // Satışta ortalama maliyetten düşüş yap
                        const avgCost = positions[assetKey].totalAmount > 0 
                                        ? (positions[assetKey].totalCost / positions[assetKey].totalAmount) 
                                        : 0;
                        
                        positions[assetKey].totalAmount -= t.amount;
                        positions[assetKey].totalCost -= (avgCost * t.amount);
                    }
                });
            }

            // 2. positions objesini diziye çevir ve KAR/ZARAR hesapla
            portfolioPositions = Object.values(positions)
                .filter(p => p.totalAmount > 0.001) // Sıfırdan büyük olanları göster (Küsürat hatasını önle)
                .map(p => {
                    // --- KRİTİK DÜZELTME: FİYAT BULMA MANTIĞI ---
                    let currentPrice = 0;
                    
                    // 1. Assets listesinde tam eşleşme ara (ID veya İsim)
                    let marketAsset = assets.find(a => 
                        a.id === p.assetId || 
                        a.name === p.assetName ||
                        (p.assetId && a.id.includes(p.assetId)) // Kısmi eşleşme (AKBNK -> AKBNK.IS gibi)
                    );

                    if (marketAsset) {
                        currentPrice = marketAsset.currentPrice;
                    } else {
                        // 2. Eğer piyasada fiyat yoksa, son işlem fiyatını (Maliyetini) baz al
                        // Böylece Kar/Zarar 0 görünür ama "NaN" veya "-%100" hatası vermez.
                        console.warn("Fiyat bulunamadı:", p.assetId, "- Maliyet baz alınıyor.");
                        currentPrice = p.totalCost / p.totalAmount;
                    }

                    // Ortalama Maliyet
                    const avgBuyPrice = p.totalCost / p.totalAmount;

                    // Güncel Değer
                    const currentValue = p.totalAmount * currentPrice;

                    // Kar / Zarar
                    const profitLoss = currentValue - p.totalCost;
                    
                    // Yüzde (Sıfıra bölünme hatasını önle)
                    const profitLossPercent = p.totalCost > 0 ? (profitLoss / p.totalCost) * 100 : 0;

                    return {
                        assetId: p.assetId,
                        assetName: p.assetName,
                        currentAmount: p.totalAmount,
                        avgBuyPrice: avgBuyPrice,
                        totalCost: p.totalCost,
                        currentPrice: currentPrice,
                        currentValue: currentValue,
                        profitLoss: profitLoss,
                        profitLossPercent: profitLossPercent
                    };
                });
        }
 //------------------------------
async function loadBrokerData(brokerId) {
        try {
            const response = await fetch(`/api/broker/dashboard/${brokerId}`);
            const data = await response.json();

            if (data.success) {
                // 1. Müşteri Listesi
                clients = data.clients || [];
                
                // 2. Performans Verileri (Grafik İçin)
                monthlyStats = data.monthlyPerformance || [];
                // --- 2.1 Son işlemleri kaydet ---
                latestTransactions = data.recentTransactions || [];

                // 3. Broker İstatistik Kartları (Üst Kısım)
                if (data.stats) {
                    brokerData = {
                        name: state.currentUser.name + ' ' + state.currentUser.surname,
                        email: state.currentUser.email,
                        position: 'Kıdemli Yatırım Danışmanı',
                        // Python'dan gelen gerçek hesaplanmış veriler:
                        totalCommission: data.stats.totalCommission || 0,
                        monthlyCommission: data.stats.monthlyCommission || 0,
                        activeClients: data.stats.activeClients || 0, 
                        accountCount: clients.reduce((sum, c) => sum + c.accounts.length, 0)
                    };
                }

                // 4. Hesap Listesi (İşlem ekranı için)
                accounts = [];
                clients.forEach(c => {
                    if (c.accounts) {
                        c.accounts.forEach(a => {
                            accounts.push({
                                id: a.accountId,
                                clientName: c.name,
                                balance: a.balance,
                                holdings: a.holdings // Bunu eklemeyi unutma
                            });
                        });
                    }
                });

                render();
            }
        } catch (error) {
            console.error('Broker veri hatası:', error);
        }
    }
//***********************
//-----------------------
// --- BU EKSİK FONKSİYONLARI logout() veya setTab() ALTINA YAPIŞTIR ---

    // Alış/Satış Butonları için Fonksiyon
    function setTransactionType(type) {
        state.transactionForm.transactionType = type;
        
        // Tip değiştiğinde formu temizle (Temiz bir sayfa aç)
        // Varlık listesi değişeceği için seçili varlığı sıfırlamak en güvenlisidir.
        state.transactionForm.selectedAsset = '';
        state.transactionForm.amount = '';
        state.transactionForm.unitPrice = '';
        
        render(); // Burada render mecburi çünkü buton renkleri ve dropdown içeriği değişiyor
    }
    // Formdaki değişiklikleri yöneten fonksiyon
    function handleTransactionFormChange() {
        // Form elemanlarını al
        const accountEl = document.getElementById('selectedAccount');
        const assetEl = document.getElementById('selectedAsset');
        const amountEl = document.getElementById('amount');
        const unitPriceEl = document.getElementById('unitPrice');

        // Önceki seçimi kaydet
        const previousAsset = state.transactionForm.selectedAsset;

        // State'i güncelle
        if(accountEl) state.transactionForm.selectedAccount = accountEl.value;
        if(assetEl) state.transactionForm.selectedAsset = assetEl.value;
        if(amountEl) state.transactionForm.amount = amountEl.value;
        if(unitPriceEl) state.transactionForm.unitPrice = unitPriceEl.value;

        // --- FİYAT OTOMATİK DOLDURMA (ALIŞ VE SATIŞ İÇİN) ---
        // Varlık değiştiyse VE fiyat kutusu henüz elle doldurulmadıysa
        if (state.transactionForm.selectedAsset && state.transactionForm.selectedAsset !== previousAsset) {
            
            const selectedVal = state.transactionForm.selectedAsset; // Örn: "THY (Türk Hava Yolları)" veya "THYAO.IS"
            
            // GELİŞMİŞ ARAMA: ID, İsim veya İçerik eşleşmesi
            const asset = assets.find(a => 
                a.id === selectedVal || 
                a.name === selectedVal ||
                selectedVal.includes(a.name) || // "THY (Türk Hava Yolları)".includes("Türk Hava Yolları") -> TRUE
                a.name.includes(selectedVal)    // "SASA".includes("SASA") -> TRUE
            );
            
            if (asset && asset.currentPrice > 0) {
                // Fiyatı State'e yaz
                state.transactionForm.unitPrice = asset.currentPrice.toString();
                
                // Input kutusunu da anında güncelle (Render beklemeden görsel düzelme)
                if(unitPriceEl) unitPriceEl.value = asset.currentPrice;
            } else {
                // Eşleşme bulunamazsa veya fiyat 0 ise, ama elimizde veri varsa
                // Belki manuel bir harita kontrolü ekleyebiliriz veya boş bırakırız.
                console.log("Fiyat eşleşmesi bulunamadı:", selectedVal);
            }
            
            // Sadece varlık değişince render yap (Mavi kutu güncellensin)
            render();
            return;
        }

        // Miktar veya Fiyat değişiyorsa sadece sayıları güncelle (Focus kaybolmasın)
        updateTransactionSummary();
    }
//------------------------
//------------------------
// --- YENİ FONKSİYON: Varlık Listesini Güncelle ---
    function updateAssetDropdown() {
        const type = state.transactionForm.transactionType; // 'ALIS' veya 'SATIS'
        const accountId = document.getElementById('selectedAccount').value;
        const assetSelect = document.getElementById('selectedAsset');

        // Önce mevcut listeyi temizle (İlk seçenek hariç)
        assetSelect.innerHTML = '<option value="">Varlık seçiniz...</option>';

        if (!accountId) return; // Hesap seçili değilse boş kalsın

        // Tüm hesaplar içinden seçili hesabı bul
        let selectedAccData = null;
        // accounts listesi 'loadBrokerData' içinde oluşturulmuştu, onu kullanıyoruz
        // Ancak accounts listesinde 'holdings' olmayabilir, 'clients' listesinden bulalım daha garanti.
        
        for (const client of clients) {
            const acc = client.accounts.find(a => a.accountId.toString() === accountId.toString());
            if (acc) {
                selectedAccData = acc;
                break;
            }
        }

        if (type === 'ALIS') {
            // ALIŞ ise: Tüm varlıkları listele (Global 'assets' listesinden)
            assets.forEach(asset => {
                const opt = document.createElement('option');
                opt.value = asset.id; // Örn: THYAO
                opt.text = `${asset.id} - ${asset.name} - ₺${asset.currentPrice}`;
                assetSelect.appendChild(opt);
            });
        } 
        else if (type === 'SATIS') {
            // SATIŞ ise: Sadece elde olanları listele (Backend'den gelen 'holdings' listesinden)
            if (selectedAccData && selectedAccData.holdings && selectedAccData.holdings.length > 0) {
                selectedAccData.holdings.forEach(h => {
                    // ID eşleştirmesi: Backend ID (1) gönderiyor, Frontend Kod (THYAO) kullanıyor.
                    // Bu örnekte basitçe Backend'den gelen İsmi gösteriyoruz.
                    // Eğer asset_map kullanıyorsan ID'yi koda çevirmen gerekebilir.
                    
                    // Basit çözüm: Backend'den gelen ID'yi value yapalım.
                    // NOT: create_transaction fonksiyonun ID ile çalışacak şekilde güncellenmişti, bu sorun olmaz.
                    
                    const opt = document.createElement('option');
                    // Frontend'deki global assets listesinden güncel fiyatı bulmaya çalışalım
                    // (İsim benzerliğinden veya ID haritasından)
                    // Şimdilik value olarak varlık ID'sini veya adını veriyoruz.
                    
                    // Burada küçük bir numara yapıyoruz: Backend'den gelen ID'yi asset_map tersine çevirebiliriz
                    // Veya direkt ID göndeririz.
                    
                    // Şimdilik kullanıcı dostu görünüm:
                    opt.value = h.assetName; // create_transaction bunu "LIKE" ile veritabanında bulacak
                    opt.text = `${h.assetName} (Eldeki Adet: ${h.quantity})`;
                    assetSelect.appendChild(opt);
                });
            } else {
                // Hiç hissesi yoksa
                const opt = document.createElement('option');
                opt.text = "Satılabilecek varlık yok";
                opt.disabled = true;
                assetSelect.appendChild(opt);
            }
        }
    }
    //************************

//------------------------
async function loadMarketData() {
        try {
            console.log("Piyasa verileri güncelleniyor...");
            const response = await fetch('/api/market/assets');
            const data = await response.json();

            if (data.success) {
                // Python'dan gelen güncel listeyi state'e kaydet
                assets = data.assets;
                console.log("Piyasa verileri güncellendi:", assets);
                
                // Eğer ekranda fiyat gösteren bir yer varsa render'ı tetikle
                render();
            }
        } catch (error) {
            console.error('Piyasa veri hatası:', error);
            // Hata olursa manuel bir yedek liste tanımlayabilirsin (Opsiyonel)
        }
    }
//************************

//------------------------
function updateTransactionSummary() {
        const amount = parseFloat(document.getElementById('amount').value) || 0;
        const price = parseFloat(document.getElementById('unitPrice').value) || 0;
        
        // State'i sessizce güncelle
        state.transactionForm.amount = document.getElementById('amount').value;
        state.transactionForm.unitPrice = document.getElementById('unitPrice').value;

        const total = amount * price;
        const commission = total * 0.01;
        const netTotal = state.transactionForm.transactionType === 'ALIS' 
                         ? (total + commission) 
                         : (total - commission);

        // DOM'u doğrudan güncelle (RENDER ÇAĞIRMADAN)
        const summarySection = document.getElementById('summary-section');
        const totalEl = document.getElementById('summary-total');
        const commEl = document.getElementById('summary-commission');
        const netEl = document.getElementById('summary-net');

        if (total > 0) {
            if (summarySection) summarySection.classList.remove('hidden');
            if (totalEl) totalEl.innerText = '₺' + formatCurrency(total);
            if (commEl) commEl.innerText = '₺' + formatCurrency(commission);
            if (netEl) netEl.innerText = '₺' + formatCurrency(netTotal);
        } else {
            if (summarySection) summarySection.classList.add('hidden');
        }
    }
//************************************
//------------------------
// --- MÜŞTERİ DETAY MODAL İŞLEMLERİ ---

    function openClientModal(clientId) {
        // 1. Müşteriyi Bul
        const client = clients.find(c => String(c.id) === String(clientId));
        if (!client) return;

        // 2. HTML İçini Doldur (Temel Bilgiler)
        const initials = client.name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
        
        // Elementlerin varlığını kontrol ederek atama yapalım (Hata önlemek için)
        if(document.getElementById('modalClientName')) document.getElementById('modalClientName').innerText = client.name;
        if(document.getElementById('modalClientInitials')) document.getElementById('modalClientInitials').innerText = initials;
        if(document.getElementById('modalClientEmail')) document.getElementById('modalClientEmail').innerText = client.email;
        if(document.getElementById('modalClientPhone')) document.getElementById('modalClientPhone').innerText = client.phone;
        
        // --- RİSK PROFİLİ AYARLARI (RENKLENDİRME BURADA) ---
        const riskName = client.riskProfile.name;
        const riskEl = document.getElementById('modalRiskName');
        const maxStockEl = document.getElementById('modalMaxStock');
        const riskDescEl = document.getElementById('modalRiskDesc');

        if (riskEl) {
            riskEl.innerText = riskName;
            
            // Önce varsayılan stilleri sıfırla, sadece temel şekli koru
            riskEl.className = "px-3 py-1 rounded-full text-xs font-bold border";

            // İsme göre renk ata
            if (riskName === 'Muhafazakar' || riskName === 'Düşük Risk') {
                riskEl.classList.add('bg-green-100', 'text-green-800', 'border-green-200');
            } 
            else if (riskName === 'Agresif' || riskName === 'Yüksek Risk') {
                riskEl.classList.add('bg-red-100', 'text-red-800', 'border-red-200');
            } 
            else {
                // Varsayılan: Dengeli / Orta
                riskEl.classList.add('bg-yellow-100', 'text-yellow-800', 'border-yellow-200');
            }
        }

        if (maxStockEl) maxStockEl.innerText = `Max Hisse Oranı: %${client.riskProfile.maxStockRatio}`;
        if (riskDescEl) riskDescEl.innerText = client.riskProfile.description;

        // --- HESAP LİSTESİ ---
        const accList = document.getElementById('modalAccountsList');
        if (accList) {
            accList.innerHTML = ''; // Temizle
            if(document.getElementById('modalAccountCount')) document.getElementById('modalAccountCount').innerText = client.accounts.length;

            if (client.accounts.length > 0) {
                client.accounts.forEach(acc => {
                    accList.innerHTML += `
                        <div class="bg-white border border-gray-200 rounded-xl p-4 flex justify-between items-center hover:border-indigo-300 transition-colors">
                            <div>
                                <p class="text-xs text-gray-500 mb-1">Hesap No</p>
                                <p class="font-mono font-bold text-gray-800 text-lg">${acc.accountId}</p>
                                <p class="text-xs text-gray-400 mt-1">${acc.commissionPlan || 'Standart Plan'}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-xs text-gray-500 mb-1">Bakiye</p>
                                <p class="font-bold text-green-600 text-lg">₺${formatCurrency(acc.balance)}</p>
                                <p class="text-xs text-gray-400 mt-1">${acc.openDate ? acc.openDate.substring(0, 10) : ''}</p>
                            </div>
                        </div>
                    `;
                });
            } else {
                accList.innerHTML = '<p class="text-gray-500 text-sm text-center italic">Hesap bulunamadı.</p>';
            }
        }

        // 3. Modalı Göster
        const modal = document.getElementById('clientDetailModal');
        if(modal) {
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }
    }

    function closeClientModal() {
        const modal = document.getElementById('clientDetailModal');
        modal.classList.add('hidden');
        modal.classList.remove('flex');
    }

    // Modal dışına tıklayınca kapatma (Opsiyonel UX)
    window.onclick = function(event) {
        const modal = document.getElementById('clientDetailModal');
        if (event.target == modal) {
            closeClientModal();
        }
    }
    // --- EKSİK OLAN YARDIMCI FONKSİYONLAR ---

    // 1. Müşteri Kartına Tıklayınca Açılıp/Kapanmasını Sağlar
    function toggleClient(clientId) {
        // Eğer tıklanan zaten açıksa kapat (null yap)
        if (state.selectedClient === clientId) {
            state.selectedClient = null;
        } else {
            // Değilse o müşteriyi seçili hale getir
            state.selectedClient = clientId;
        }
        
        render(); // Ekranı yenile (Genişletilmiş alanın görünmesi için)
    }

    // 2. Arama Kutusuna Yazı Yazıldığında Çalışır
    function updateSearchQuery(query) {
        // State içindeki arama metnini güncelle
        state.searchQuery = query;
        
        render(); // Ekranı yenile (Listenin filtrelenmesi için)
    }
//**************************
//------------------------
async function toggleAccountStatus(accountId) {
        if(!confirm('Hesap durumunu değiştirmek istediğinize emin misiniz?')) return;

        try {
            const response = await fetch('/api/account/toggle-status', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ accountId: accountId })
            });
            
            const data = await response.json();
            
            if (data.success) {
                // Başarılıysa verileri yeniden yükle ki ekran güncellensin
                await loadInvestorData(state.currentUser.id);
                render();
            } else {
                alert("Hata: " + data.message);
            }
        } catch (error) {
            console.error("Hata:", error);
            alert("İşlem sırasında bir hata oluştu.");
        }
    }
//**************************
//------------------------
function renderInvestorNewTransactionTab() {
            // Seçili hesabın durumunu kontrol et
            const selectedAccId = state.transactionForm.selectedAccount;
            let isAccountActive = false;
            let selectedAccountObj = null;
            
            if (selectedAccId) {
                // String karşılaştırması yapıyoruz
                const acc = accounts.find(a => String(a.id) === String(selectedAccId));
                if (acc) {
                    selectedAccountObj = acc;
                    if (acc.status === 'Aktif') {
                        isAccountActive = true;
                    }
                }
            }

            // Varlık Listesini Hazırla (Dropdown)
            let assetOptionsHtml = '<option value="">Varlık seçiniz...</option>';
            if (state.transactionForm.transactionType === 'ALIS') {
                assetOptionsHtml += assets.map(asset => `
                    <option value="${asset.id}" ${state.transactionForm.selectedAsset === asset.id ? 'selected' : ''}>
                        ${asset.id} - ${asset.name} ${asset.currentPrice > 0 ? '(₺' + asset.currentPrice.toFixed(2) + ')' : ''}
                    </option>
                `).join('');
            } else {
                // Satış ise portföyü göster (Yatırımcı Portföyü)
                // (Burada basitlik için portföy logic'ini tam yazmadım, hesabın detayından portföyü çekmek gerekebilir)
                // Şimdilik sadece seçili varlığı gösterelim veya boş bırakalım.
                // Not: Yatırımcı tarafında portföy listesi 'portfolio' global değişkeninde olabilir.
                const myAssets = portfolio.filter(p => p.quantity > 0);
                if (myAssets.length > 0) {
                     assetOptionsHtml += myAssets.map(h => `
                        <option value="${h.assetId}" ${state.transactionForm.selectedAsset === h.assetId ? 'selected' : ''}>
                            ${h.assetName} (Adet: ${h.quantity})
                        </option>
                    `).join('');
                } else {
                     assetOptionsHtml += '<option disabled>Satılabilir varlık yok</option>';
                }
            }

            // Hesaplamalar
            const calculateTotal = () => {
                const qty = parseFloat(state.transactionForm.amount) || 0;
                const price = parseFloat(state.transactionForm.unitPrice) || 0;
                return qty * price;
            };
            const total = calculateTotal();
            const commission = total * (selectedAccountObj ? (selectedAccountObj.commissionRate || 0.01) : 0.01); 

            return `
                <div class="max-w-2xl mx-auto space-y-6">
                    ${state.showSuccess ? `
                        <div class="bg-green-50 border border-green-200 rounded-xl p-4 flex items-center gap-3 animate-fade-in">
                            ${icons.checkCircle}
                            <div><p class="font-semibold text-green-900">İşlem başarıyla gerçekleşti!</p></div>
                        </div>
                    ` : ''}

                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                        <div class="bg-gradient-to-r from-blue-600 to-indigo-600 px-6 py-4">
                            <h2 class="text-xl font-bold text-white flex items-center gap-2">
                                ${icons.plus} Yeni İşlem Emri
                            </h2>
                        </div>

                        <form id="transactionForm" class="p-6 space-y-6">
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">İşlem Yapılacak Hesap</label>
                                <select id="selectedAccount" onchange="handleTransactionFormChange()" required 
                                    class="w-full px-4 py-3 bg-gray-50 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                                    <option value="">Hesap seçiniz...</option>
                                    ${accounts.map(acc => `
                                        <option value="${acc.id}" ${String(state.transactionForm.selectedAccount) === String(acc.id) ? 'selected' : ''}>
                                            ${acc.id} (Bakiye: ₺${formatCurrency(acc.balance)}) - [${acc.status}]
                                        </option>
                                    `).join('')}
                                </select>
                            </div>

                            ${selectedAccId && !isAccountActive ? `
                                <div class="bg-red-50 border border-red-200 rounded-lg p-4 flex items-start gap-3">
                                    <div class="text-red-600 mt-0.5"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg></div>
                                    <div>
                                        <h4 class="text-sm font-bold text-red-800">Hesap Pasif Durumda</h4>
                                        <p class="text-xs text-red-600 mt-1">Bu hesap üzerinden işlem yapamazsınız. Lütfen "Hesaplarım" sekmesinden hesabı aktifleştirin.</p>
                                    </div>
                                </div>
                            ` : ''}

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">İşlem Tipi</label>
                                <div class="grid grid-cols-2 gap-4">
                                    <button type="button" onclick="setTransactionType('ALIS')" 
                                        class="p-4 rounded-lg border-2 transition-all ${state.transactionForm.transactionType === 'ALIS' ? 'border-green-500 bg-green-50 text-green-700' : 'border-gray-200 hover:border-gray-300 text-gray-600'}">
                                        <span class="font-bold">Alış</span>
                                    </button>
                                    <button type="button" onclick="setTransactionType('SATIS')" 
                                        class="p-4 rounded-lg border-2 transition-all ${state.transactionForm.transactionType === 'SATIS' ? 'border-red-500 bg-red-50 text-red-700' : 'border-gray-200 hover:border-gray-300 text-gray-600'}">
                                        <span class="font-bold">Satış</span>
                                    </button>
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Varlık</label>
                                <select id="selectedAsset" onchange="handleTransactionFormChange()" required class="w-full px-4 py-3 bg-gray-50 border border-gray-300 rounded-lg outline-none">
                                    ${assetOptionsHtml}
                                </select>
                            </div>

                            <div class="grid grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Adet</label>
                                    <input type="number" id="amount" value="${state.transactionForm.amount}" oninput="updateTransactionSummary()" required class="w-full px-4 py-3 bg-gray-50 border border-gray-300 rounded-lg outline-none" />
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Birim Fiyat</label>
                                    <input type="number" id="unitPrice" value="${state.transactionForm.unitPrice}" oninput="updateTransactionSummary()" required class="w-full px-4 py-3 bg-gray-50 border border-gray-300 rounded-lg outline-none" />
                                </div>
                            </div>

                            <div id="summary-section" class="bg-gray-50 p-4 rounded-lg border border-gray-200 ${total > 0 ? '' : 'hidden'}">
                                <div class="flex justify-between text-sm mb-1"><span>Tutar:</span> <span>₺${formatCurrency(total)}</span></div>
                                <div class="flex justify-between text-sm mb-1 text-gray-500"><span>Komisyon:</span> <span>₺${formatCurrency(commission)}</span></div>
                                <div class="flex justify-between font-bold text-lg border-t border-gray-300 pt-2 mt-2">
                                    <span>Toplam:</span> 
                                    <span class="text-indigo-600">₺${formatCurrency(state.transactionForm.transactionType === 'ALIS' ? total + commission : total - commission)}</span>
                                </div>
                            </div>

                            <button type="submit" 
                                ${!isAccountActive ? 'disabled' : ''}
                                class="w-full py-4 rounded-lg font-bold text-white shadow-lg transition-all transform hover:-translate-y-0.5 
                                ${isAccountActive 
                                    ? 'bg-gradient-to-r from-blue-600 to-indigo-600 hover:shadow-xl' 
                                    : 'bg-gray-400 cursor-not-allowed shadow-none opacity-70'}">
                                ${!isAccountActive ? 'İşlem Yapılamaz (Pasif Hesap)' : 'Emri Tamamla'}
                            </button>
                        </form>
                    </div>
                </div>
            `;
        }
//**************************
//------------------------
// --- YENİ HESAP AÇMA İŞLEMLERİ ---

    // 1. Modalı Aç ve Brokerları Yükle
    async function openNewAccountModal() {
        const modal = document.getElementById('newAccountModal');
        modal.classList.remove('hidden');
        modal.classList.add('flex');

        // Broker listesini çek
        const select = document.getElementById('newAccountBroker');
        select.innerHTML = '<option value="">Yükleniyor...</option>';

        try {
            const response = await fetch('/api/brokers');
            const data = await response.json();
            
            if(data.success) {
                select.innerHTML = '<option value="">Broker Seçiniz...</option>';
                data.brokers.forEach(b => {
                    const opt = document.createElement('option');
                    opt.value = b.id;
                    opt.text = b.name;
                    select.appendChild(opt);
                });
            }
        } catch (e) {
            select.innerHTML = '<option value="">Hata oluştu</option>';
        }
    }

    // 2. Modalı Kapat
    function closeNewAccountModal() {
        document.getElementById('newAccountModal').classList.add('hidden');
        document.getElementById('newAccountModal').classList.remove('flex');
    }

    // 3. Formu Gönder (Kaydet)
    async function handleNewAccountSubmit(e) {
        e.preventDefault();
        
        const brokerId = document.getElementById('newAccountBroker').value;
        const deposit = document.getElementById('newAccountDeposit').value;

        if(!brokerId || !deposit) {
            alert("Lütfen tüm alanları doldurun.");
            return;
        }

        try {
            const response = await fetch('/api/account/create', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    investorId: state.currentUser.id,
                    brokerId: brokerId,
                    initialDeposit: deposit
                })
            });

            const data = await response.json();

            if (data.success) {
                alert("Hesap başarıyla oluşturuldu!");
                closeNewAccountModal();
                // Sayfayı yenile ki yeni hesap görünsün
                loadInvestorData(state.currentUser.id);
            } else {
                alert("Hata: " + data.message);
            }
        } catch (error) {
            console.error("Hesap açma hatası:", error);
        }
    }
//**************************
    </script>

<div id="clientDetailModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center z-50 backdrop-blur-sm transition-all duration-300">
        <div class="bg-white w-full max-w-2xl rounded-2xl shadow-2xl overflow-hidden transform transition-all scale-100 m-4">
            
            <div class="bg-gradient-to-r from-purple-600 to-indigo-600 px-6 py-4 flex justify-between items-center">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 bg-white/20 backdrop-blur-md rounded-xl flex items-center justify-center text-white font-bold text-xl">
                        <span id="modalClientInitials">AD</span>
                    </div>
                    <div>
                        <h3 class="text-white text-lg font-bold">Müşteri Detayları</h3>
                        <p id="modalClientName" class="text-purple-100 text-sm">Ad Soyad</p>
                    </div>
                </div>
                <button onclick="closeClientModal()" class="text-white/70 hover:text-white transition-colors bg-white/10 hover:bg-white/20 p-2 rounded-lg">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>

            <div class="p-6 max-h-[70vh] overflow-y-auto custom-scrollbar space-y-6">
                
                <div class="bg-gray-50 p-4 rounded-xl border border-gray-100">
                    <div class="flex items-start gap-3">
                        <div class="mt-1 text-gray-400">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500 uppercase font-semibold">E-posta</p>
                            <p id="modalClientEmail" class="text-gray-900 font-medium">email@example.com</p>
                        </div>
                    </div>
                    <div class="flex items-start gap-3 mt-4">
                        <div class="mt-1 text-gray-400">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path></svg>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500 uppercase font-semibold">Telefon</p>
                            <p id="modalClientPhone" class="text-gray-900 font-medium">+90 555 555 55 55</p>
                        </div>
                    </div>
                </div>

                <div>
                    <h4 class="text-sm font-bold text-gray-900 mb-3 flex items-center gap-2">
                        <svg class="w-5 h-5 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        Risk Profili
                    </h4>
                    <div class="bg-white border border-gray-200 rounded-xl p-4 shadow-sm">
                        <div class="flex justify-between items-center mb-2">
                            <span id="modalRiskName" class="px-3 py-1 rounded-full text-xs font-bold bg-yellow-100 text-yellow-800 border border-yellow-200">
                                Dengeli
                            </span>
                            <span id="modalMaxStock" class="text-xs text-gray-500">Max Hisse Oranı: %60</span>
                        </div>
                        <p id="modalRiskDesc" class="text-sm text-gray-600">Orta düzey risk toleransı.</p>
                    </div>
                </div>

                <div>
                    <h4 class="text-sm font-bold text-gray-900 mb-3">Hesaplar (<span id="modalAccountCount">0</span>)</h4>
                    <div id="modalAccountsList" class="space-y-3">
                        </div>
                </div>

            </div>

            <div class="bg-gray-50 px-6 py-4 flex gap-3 border-t border-gray-100">
                <button onclick="closeClientModal()" class="flex-1 bg-indigo-600 text-white py-2.5 rounded-xl font-medium hover:bg-indigo-700 transition-colors shadow-sm shadow-indigo-200">
                    İşlem Geçmişini Gör
                </button>
                <button onclick="closeClientModal()" class="flex-1 bg-white border border-gray-200 text-gray-700 py-2.5 rounded-xl font-medium hover:bg-gray-50 transition-colors">
                    Portföyü Görüntüle
                </button>
            </div>
        </div>
    </div>
    <div id="newAccountModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center z-50 backdrop-blur-sm transition-all duration-300">
        <div class="bg-white w-full max-w-lg rounded-2xl shadow-2xl overflow-hidden transform transition-all scale-100 m-4">
            
            <div class="bg-gradient-to-r from-blue-600 to-indigo-600 px-6 py-4 flex justify-between items-center">
                <h3 class="text-white text-lg font-bold flex items-center gap-2">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                    Yeni Hesap Oluştur
                </h3>
                <button onclick="closeNewAccountModal()" class="text-white/70 hover:text-white transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>

            <form onsubmit="handleNewAccountSubmit(event)" class="p-6 space-y-6">
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Broker Seçimi</label>
                    <select id="newAccountBroker" required class="w-full px-4 py-3 bg-gray-50 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none">
                        <option value="">Broker Yükleniyor...</option>
                    </select>
                    <p class="text-xs text-gray-500 mt-1">Hesabınızı yönetecek danışmanı seçiniz.</p>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Başlangıç Yatırımı (TL)</label>
                    <div class="relative">
                        <span class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-500 font-bold">₺</span>
                        <input type="number" id="newAccountDeposit" required min="1000" placeholder="Örn: 50000" 
                            class="w-full pl-8 pr-4 py-3 bg-gray-50 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none" />
                    </div>
                </div>

                <div class="bg-blue-50 p-4 rounded-xl border border-blue-100 flex gap-3">
                    <svg class="w-5 h-5 text-blue-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    <p class="text-sm text-blue-800">Hesabınız anında aktif edilecek ve "Standart Komisyon Planı" uygulanacaktır.</p>
                </div>

                <div class="flex gap-3 pt-2">
                    <button type="button" onclick="closeNewAccountModal()" class="flex-1 py-3 bg-gray-100 text-gray-700 rounded-xl font-medium hover:bg-gray-200 transition-colors">İptal</button>
                    <button type="submit" class="flex-1 py-3 bg-blue-600 text-white rounded-xl font-medium hover:bg-blue-700 transition-colors shadow-lg">Hesabı Oluştur</button>
                </div>
            </form>
        </div>
    </div>
</body>
</html>